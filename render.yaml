services:
  # Express Backend API
  - type: web
    name: quord-api
    env: node
    region: oregon
    plan: starter
    buildCommand: cd server && npm install && npx prisma generate && npx prisma migrate deploy
    startCommand: cd server && npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3001
      - key: DATABASE_URL
        sync: false  # Set in Render dashboard
      - key: REDIS_URL
        sync: false  # Set in Render dashboard
      - key: JWT_ACCESS_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: JWT_ACCESS_EXPIRES_IN
        value: 15m
      - key: JWT_REFRESH_EXPIRES_IN
        value: 7d
      - key: CORS_ORIGIN
        value: https://app.propertyhack.com,https://propertyhack.com
      - key: GEMINI_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: RESEND_FROM_EMAIL
        value: post@mail.propertyhack.com
      - key: LINKEDIN_CLIENT_ID
        sync: false
      - key: PropertyHack_LINKEDIN_CLIENT_SECRET
        sync: false
      - key: PropertyHack_LINKEDIN_REDIRECT_URI
        value: https://api.propertyhack.com/api/auth/linkedin/callback
      - key: GOOGLE_CLIENT_ID
        sync: false
      - key: GOOGLE_CLIENT_SECRET
        sync: false
      - key: GOOGLE_CALLBACK_URL
        value: https://api.propertyhack.com/api/oauth/google/callback
      - key: STRIPE_SECRET_KEY
        sync: false
      - key: STRIPE_PRO_PRICE_ID
        sync: false
      - key: STRIPE_WEBHOOK_SECRET
        sync: false
      - key: NEWSAPI_API_KEY
        sync: false
      - key: PERPLEXITY_API_KEY
        sync: false
      - key: CRON_SECRET
        sync: false  # Set in Render dashboard
    healthCheckPath: /health

  # Cron Job: Process scheduled posts every 2 minutes
  - type: cron
    name: quord-scheduled-posts-processor
    env: node
    schedule: "*/2 * * * *"
    buildCommand: echo "No build needed for cron job"
    startCommand: |
      curl -X POST https://api.propertyhack.com/api/cron/process-scheduled-posts \
        -H "X-Cron-Secret: $CRON_SECRET" \
        -H "Content-Type: application/json" \
        --fail --silent --show-error
    envVars:
      - key: CRON_SECRET
        sync: false  # Must match web service CRON_SECRET

  # PostgreSQL Database
  - type: pserv
    name: quord-postgres
    env: docker
    plan: starter
    image: postgres:16-alpine
    disk:
      name: quord-postgres-data
      mountPath: /var/lib/postgresql/data
      sizeGB: 10
    envVars:
      - key: POSTGRES_USER
        value: quord
      - key: POSTGRES_PASSWORD
        generateValue: true
      - key: POSTGRES_DB
        value: quord_production

  # Redis for BullMQ
  - type: pserv
    name: quord-redis
    env: docker
    plan: starter
    image: redis:7-alpine
    disk:
      name: quord-redis-data
      mountPath: /data
      sizeGB: 1
